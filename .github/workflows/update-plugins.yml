# ========================================
# Obsidian æ’ä»¶æ•°æ®è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# ========================================
#
# åŠŸèƒ½ï¼š
# 1. æ¯å¤©è‡ªåŠ¨ä» Obsidian å®˜æ–¹ API è·å–æœ€æ–°æ’ä»¶æ•°æ®
# 2. è‡ªåŠ¨ç”Ÿæˆæ’ä»¶è¯¦æƒ…é¡µé¢
# 3. æäº¤å˜æ›´å¹¶æ¨é€åˆ° GitHub
# 4. è§¦å‘ Netlify è‡ªåŠ¨éƒ¨ç½²
#
# æ‰§è¡Œæ—¶é—´ï¼š
# - æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2:00ï¼ˆUTC 18:00ï¼‰
# - æ”¯æŒæ‰‹åŠ¨è§¦å‘
#
# ä½œè€…ï¼šAugment AI Agent
# åˆ›å»ºæ—¥æœŸï¼š2025-10-05
# ========================================

name: è‡ªåŠ¨æ›´æ–°æ’ä»¶æ•°æ®

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 2:00 æ‰§è¡Œï¼ˆUTC 18:00ï¼‰
  schedule:
    - cron: '0 18 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿æ•°æ®æœªå˜åŒ–ï¼‰'
        required: false
        type: boolean
        default: false

# è®¾ç½®æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™ä»¥æäº¤ä»£ç 

jobs:
  update-plugins:
    name: æ›´æ–°æ’ä»¶æ•°æ®
    runs-on: ubuntu-latest
    
    steps:
      # ========== æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  ==========
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äº git diff
      
      # ========== æ­¥éª¤2ï¼šè®¾ç½® Node.js ç¯å¢ƒ ==========
      - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'docs/package-lock.json'
      
      # ========== æ­¥éª¤3ï¼šå®‰è£…ä¾èµ– ==========
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: ./docs
        run: |
          echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
          npm ci
          echo "âœ“ ä¾èµ–å®‰è£…å®Œæˆ"
      
      # ========== æ­¥éª¤4ï¼šè·å–æ’ä»¶æ•°æ® ==========
      - name: ğŸ”„ è·å–æ’ä»¶æ•°æ®
        id: fetch_data
        run: |
          echo "æ­£åœ¨ä» Obsidian å®˜æ–¹ API è·å–æ’ä»¶æ•°æ®..."
          node scripts/fetch-plugins-data.js
          
          if [ $? -eq 0 ]; then
            echo "âœ“ æ’ä»¶æ•°æ®è·å–æˆåŠŸ"
            echo "fetch_success=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— æ’ä»¶æ•°æ®è·å–å¤±è´¥"
            echo "fetch_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # ========== æ­¥éª¤5ï¼šç”Ÿæˆæ’ä»¶é¡µé¢ ==========
      - name: ğŸ“ ç”Ÿæˆæ’ä»¶é¡µé¢
        id: generate_pages
        if: steps.fetch_data.outputs.fetch_success == 'true'
        run: |
          echo "æ­£åœ¨ç”Ÿæˆæ’ä»¶è¯¦æƒ…é¡µé¢..."
          node scripts/generate-plugin-pages.js
          
          if [ $? -eq 0 ]; then
            echo "âœ“ æ’ä»¶é¡µé¢ç”ŸæˆæˆåŠŸ"
            echo "generate_success=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— æ’ä»¶é¡µé¢ç”Ÿæˆå¤±è´¥"
            echo "generate_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # ========== æ­¥éª¤6ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ– ==========
      - name: ğŸ” æ£€æŸ¥æ•°æ®å˜åŒ–
        id: check_changes
        if: steps.generate_pages.outputs.generate_success == 'true'
        run: |
          echo "æ­£åœ¨æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–..."
          
          # æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet docs/src/.vuepress/public/data/; then
            echo "æ•°æ®æ–‡ä»¶æœªå˜åŒ–"
            DATA_CHANGED=false
          else
            echo "âœ“ æ•°æ®æ–‡ä»¶å·²å˜åŒ–"
            DATA_CHANGED=true
          fi
          
          # æ£€æŸ¥æ’ä»¶é¡µé¢æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet docs/src/zh/plugins/; then
            echo "æ’ä»¶é¡µé¢æœªå˜åŒ–"
            PAGES_CHANGED=false
          else
            echo "âœ“ æ’ä»¶é¡µé¢å·²å˜åŒ–"
            PAGES_CHANGED=true
          fi
          
          # åˆ¤æ–­æ˜¯å¦æœ‰ä»»ä½•å˜åŒ–
          if [ "$DATA_CHANGED" = true ] || [ "$PAGES_CHANGED" = true ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æœªæ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
          
          # ç»Ÿè®¡å˜åŒ–
          CHANGED_FILES=$(git diff --name-only | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "å˜åŒ–çš„æ–‡ä»¶æ•°é‡: $CHANGED_FILES"
      
      # ========== æ­¥éª¤7ï¼šæäº¤å¹¶æ¨é€å˜æ›´ ==========
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        if: |
          steps.check_changes.outputs.has_changes == 'true' ||
          github.event.inputs.force_update == 'true'
        run: |
          echo "æ­£åœ¨é…ç½® Git..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo "æ­£åœ¨æ·»åŠ å˜æ›´æ–‡ä»¶..."
          git add docs/src/.vuepress/public/data/
          git add docs/src/zh/plugins/
          git add data/plugin-history.json
          git add data/plugin-changes.json
          git add translations/plugin-translations.json

          echo "æ­£åœ¨æäº¤å˜æ›´..."
          COMMIT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          CHANGED_FILES="${{ steps.check_changes.outputs.changed_files }}"

          git commit -m "chore: è‡ªåŠ¨æ›´æ–°æ’ä»¶æ•°æ® ${COMMIT_DATE}" \
                     -m "å˜æ›´æ–‡ä»¶æ•°é‡: ${CHANGED_FILES}" \
                     -m "è§¦å‘æ–¹å¼: ${{ github.event_name }}"

          echo "æ­£åœ¨æ¨é€åˆ° GitHub..."
          git push

          echo "âœ“ å˜æ›´å·²æˆåŠŸæ¨é€åˆ° GitHub"
          echo "âœ“ Netlify å°†è‡ªåŠ¨å¼€å§‹éƒ¨ç½²"
      
      # ========== æ­¥éª¤8ï¼šè¾“å‡ºæ‘˜è¦ ==========
      - name: ğŸ“Š è¾“å‡ºæ‰§è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”„ æ’ä»¶æ•°æ®è‡ªåŠ¨æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.fetch_data.outputs.fetch_success }}" = "true" ]; then
            echo "âœ… æ•°æ®è·å–: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ•°æ®è·å–: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.generate_pages.outputs.generate_success }}" = "true" ]; then
            echo "âœ… é¡µé¢ç”Ÿæˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ é¡µé¢ç”Ÿæˆ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… æ•°æ®å˜åŒ–: æ˜¯" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ å˜æ›´æ–‡ä»¶: ${{ steps.check_changes.outputs.changed_files }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ•°æ®å˜åŒ–: å¦" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ å¦‚æœæœ‰å˜æ›´ï¼ŒNetlify å°†è‡ªåŠ¨å¼€å§‹éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "========================================" >> $GITHUB_STEP_SUMMARY
      
      # ========== æ­¥éª¤9ï¼šå¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰ ==========
      - name: ğŸ“§ å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'âš ï¸ æ’ä»¶æ•°æ®è‡ªåŠ¨æ›´æ–°å¤±è´¥';
            const body = `
            ## æ‰§è¡Œå¤±è´¥è¯¦æƒ…
            
            - **å·¥ä½œæµ**: ${context.workflow}
            - **è¿è¡ŒID**: ${context.runId}
            - **è§¦å‘æ–¹å¼**: ${context.eventName}
            - **å¤±è´¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
            
            è¯·æ£€æŸ¥ [GitHub Actions æ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId}) äº†è§£è¯¦æƒ…ã€‚
            
            ---
            *æ­¤é—®é¢˜ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
            `;
            
            // åˆ›å»º Issueï¼ˆå¯é€‰ï¼Œå–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ï¼‰
            // await github.rest.issues.create({
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   title: title,
            //   body: body,
            //   labels: ['automation', 'bug']
            // });
            
            console.log('å¤±è´¥é€šçŸ¥å·²è®°å½•');

