# 插件数据来源与合并规则技术文档

**文档创建日期**：2025-10-05  
**文档作者**：Augment AI Agent  
**文档版本**：v1.0

---

## 1. 概述

本文档详细说明了 Obsidian 插件数据的来源、获取方式、合并规则以及数据处理流程。

### 1.1 数据用途

插件数据用于以下功能：
- 插件列表页面展示（`/zh/plugins/`）
- 插件详情页面生成（`/zh/plugins/{plugin-id}.md`）
- 统计面板数据展示（总插件数、总下载量等）
- 排行榜功能（按下载量、周下载量、月下载量排序）

### 1.2 相关脚本

- **数据获取脚本**：`scripts/fetch-plugins-data.js`
- **页面生成脚本**：`scripts/generate-plugin-pages.js`
- **页面模板**：`scripts/templates/plugin-detail.md`

---

## 2. 数据来源

### 2.1 GitHub 官方数据源

所有插件数据来源于 Obsidian 官方 GitHub 仓库的两个 JSON 文件：

#### 2.1.1 插件基础信息
- **数据源**：`https://raw.githubusercontent.com/obsidianmd/obsidian-releases/master/community-plugins.json`
- **更新频率**：实时更新（由 Obsidian 官方维护）
- **数据结构**：
```json
[
  {
    "id": "plugin-id",
    "name": "Plugin Name",
    "author": "Author Name",
    "description": "Plugin description",
    "repo": "username/repository"
  }
]
```

#### 2.1.2 插件统计数据
- **数据源**：`https://raw.githubusercontent.com/obsidianmd/obsidian-releases/master/community-plugin-stats.json`
- **更新频率**：实时更新（由 Obsidian 官方维护）
- **数据结构**：
```json
{
  "plugin-id": {
    "downloads": 1234567,
    "updated": 1696291200000
  }
}
```

### 2.2 数据字段说明

| 字段名 | 来源 | 类型 | 说明 |
|--------|------|------|------|
| `id` | community-plugins.json | String | 插件唯一标识符 |
| `name` | community-plugins.json | String | 插件名称 |
| `author` | community-plugins.json | String | 插件作者 |
| `description` | community-plugins.json | String | 插件描述 |
| `repo` | community-plugins.json | String | GitHub 仓库地址 |
| `downloads` | community-plugin-stats.json | Number | 总下载量 |
| `updated` | community-plugin-stats.json | Number | 最后更新时间戳（毫秒） |

---

## 3. 数据合并规则

### 3.1 合并算法

数据合并通过 `mergePluginData()` 函数实现，合并规则如下：

```javascript
function mergePluginData(pluginsData, statsData) {
  const mergedData = pluginsData.map(plugin => {
    const stats = statsData[plugin.id] || {};
    
    return {
      id: plugin.id,                    // 来自 community-plugins.json
      name: plugin.name,                // 来自 community-plugins.json
      author: plugin.author,            // 来自 community-plugins.json
      description: plugin.description,  // 来自 community-plugins.json
      repo: plugin.repo,                // 来自 community-plugins.json
      downloads: stats.downloads || 0,  // 来自 community-plugin-stats.json
      updated: stats.updated || 0,      // 来自 community-plugin-stats.json
      // 衍生字段（后续计算）
      weeklyDownloads: 0,
      monthlyDownloads: 0,
      weeklyGrowth: 0,
      monthlyGrowth: 0
    };
  });
  
  return mergedData;
}
```

### 3.2 合并规则详解

1. **以插件基础信息为主**：遍历 `community-plugins.json` 中的所有插件
2. **按 ID 匹配统计数据**：使用 `plugin.id` 作为键，从 `community-plugin-stats.json` 中查找对应的统计数据
3. **缺失值处理**：
   - 如果统计数据中没有该插件的记录，`downloads` 和 `updated` 默认为 `0`
   - 确保所有插件都有完整的数据结构，即使某些字段为空

### 3.3 数据完整性保证

- **插件总数**：以 `community-plugins.json` 为准
- **统计数据**：如果某个插件在 `community-plugin-stats.json` 中不存在，不会影响该插件的展示，只是统计数据为 0

---

## 4. 衍生数据计算

### 4.1 周下载量和月下载量

由于官方 API 不提供历史下载数据，我们使用估算方法计算周下载量和月下载量：

```javascript
function calculateDerivedData(plugins) {
  const enhancedPlugins = plugins.map(plugin => {
    // 估算周下载量 (假设为总下载量的 1-5%)
    const weeklyDownloads = Math.floor(plugin.downloads * (0.01 + Math.random() * 0.04));
    
    // 估算月下载量 (假设为总下载量的 5-15%)
    const monthlyDownloads = Math.floor(plugin.downloads * (0.05 + Math.random() * 0.10));
    
    // 计算增长率
    const weeklyGrowth = plugin.downloads > 0 ? (weeklyDownloads / plugin.downloads * 100) : 0;
    const monthlyGrowth = plugin.downloads > 0 ? (monthlyDownloads / plugin.downloads * 100) : 0;
    
    return {
      ...plugin,
      weeklyDownloads,
      monthlyDownloads,
      weeklyGrowth: parseFloat(weeklyGrowth.toFixed(2)),
      monthlyGrowth: parseFloat(monthlyGrowth.toFixed(2))
    };
  });
  
  return enhancedPlugins;
}
```

### 4.2 估算规则说明

| 字段 | 估算方法 | 说明 |
|------|----------|------|
| `weeklyDownloads` | 总下载量 × (1% ~ 5%) | 随机取值，模拟真实波动 |
| `monthlyDownloads` | 总下载量 × (5% ~ 15%) | 随机取值，模拟真实波动 |
| `weeklyGrowth` | (周下载量 / 总下载量) × 100 | 百分比，保留2位小数 |
| `monthlyGrowth` | (月下载量 / 总下载量) × 100 | 百分比，保留2位小数 |

**注意**：这些数据仅用于展示和排序，不代表真实的周/月下载量。

---

## 5. 统计数据生成

### 5.1 统计指标

通过 `generateStats()` 函数生成以下统计数据：

```javascript
function generateStats(plugins, rankings) {
  const now = Date.now();
  const oneWeekAgo = now - 7 * 24 * 60 * 60 * 1000;
  const oneMonthAgo = now - 30 * 24 * 60 * 60 * 1000;
  
  // 计算新增插件数
  const weeklyNewPlugins = plugins.filter(p => p.updated > oneWeekAgo).length;
  const monthlyNewPlugins = plugins.filter(p => p.updated > oneMonthAgo).length;
  
  // 计算总下载量
  const totalDownloads = plugins.reduce((sum, p) => sum + p.downloads, 0);
  
  return {
    totalPlugins: plugins.length,
    totalDownloads,
    weeklyNewPlugins,
    monthlyNewPlugins,
    ...rankings,
    lastUpdated: now
  };
}
```

### 5.2 统计指标说明

| 指标 | 计算方法 | 说明 |
|------|----------|------|
| `totalPlugins` | 插件数组长度 | 插件总数 |
| `totalDownloads` | 所有插件下载量之和 | 总下载量 |
| `weeklyNewPlugins` | 最近7天更新的插件数 | 本周新增插件数 |
| `monthlyNewPlugins` | 最近30天更新的插件数 | 本月新增插件数 |
| `lastUpdated` | 当前时间戳 | 数据最后更新时间 |

---

## 6. 排行榜数据

### 6.1 排行榜类型

通过 `generateRankings()` 函数生成三种排行榜：

```javascript
function generateRankings(plugins) {
  // 按总下载量排序取前10
  const topByDownloads = [...plugins]
    .sort((a, b) => b.downloads - a.downloads)
    .slice(0, 10);
  
  // 按周下载量排序取前10
  const topByWeekly = [...plugins]
    .sort((a, b) => b.weeklyDownloads - a.weeklyDownloads)
    .slice(0, 10);
  
  // 按月下载量排序取前10
  const topByMonthly = [...plugins]
    .sort((a, b) => b.monthlyDownloads - a.monthlyDownloads)
    .slice(0, 10);
  
  return {
    topByDownloads,
    topByWeekly,
    topByMonthly
  };
}
```

### 6.2 排行榜说明

| 排行榜 | 排序字段 | 数量 | 用途 |
|--------|----------|------|------|
| `topByDownloads` | `downloads` | 前10名 | 总下载量排行榜 |
| `topByWeekly` | `weeklyDownloads` | 前10名 | 周下载量排行榜 |
| `topByMonthly` | `monthlyDownloads` | 前10名 | 月下载量排行榜 |

---

## 7. 数据存储

### 7.1 存储位置

合并后的数据保存在以下位置：

- **插件数据**：`docs/src/.vuepress/public/data/plugins.json`
- **统计数据**：`docs/src/.vuepress/public/data/plugin-stats.json`

### 7.2 数据格式

#### 7.2.1 plugins.json
```json
[
  {
    "id": "dataview",
    "name": "Dataview",
    "author": "Michael Brenan",
    "description": "Advanced queries over your vault for the data-obsessed.",
    "repo": "blacksmithgu/obsidian-dataview",
    "downloads": 3300000,
    "updated": 1712534400000,
    "weeklyDownloads": 99000,
    "monthlyDownloads": 330000,
    "weeklyGrowth": 3.00,
    "monthlyGrowth": 10.00
  }
]
```

#### 7.2.2 plugin-stats.json
```json
{
  "totalPlugins": 2635,
  "totalDownloads": 91500000,
  "weeklyNewPlugins": 83,
  "monthlyNewPlugins": 271,
  "topByDownloads": [...],
  "topByWeekly": [...],
  "topByMonthly": [...],
  "lastUpdated": 1728086400000
}
```

---

## 8. 数据更新流程

### 8.1 手动更新

运行以下命令手动更新数据：

```bash
# 获取最新插件数据
node scripts/fetch-plugins-data.js

# 生成插件详情页面
node scripts/generate-plugin-pages.js
```

### 8.2 更新频率建议

- **开发环境**：按需手动更新
- **生产环境**：建议每天自动更新一次（可通过 CI/CD 实现）

### 8.3 错误处理

脚本内置了重试机制：
- **最大重试次数**：3次
- **重试间隔**：5秒
- **失败处理**：如果3次重试都失败，脚本会退出并输出错误信息

---

## 9. 注意事项

### 9.1 数据准确性

- ✅ **准确数据**：`id`、`name`、`author`、`description`、`repo`、`downloads`、`updated`
- ⚠️ **估算数据**：`weeklyDownloads`、`monthlyDownloads`、`weeklyGrowth`、`monthlyGrowth`

### 9.2 性能考虑

- 插件数据文件较大（约 2MB），建议使用 CDN 加速
- 统计数据文件较小（约 50KB），可直接加载

### 9.3 兼容性

- 数据格式遵循 Obsidian 官方标准
- 如果官方 API 格式发生变化，需要相应更新脚本

---

## 10. 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | 2025-10-05 | 初始版本，记录数据来源和合并规则 |

---

## 11. 相关文档

- [Obsidian 官方插件仓库](https://github.com/obsidianmd/obsidian-releases)
- [插件列表页面优化记录](docs/src/zh/documentation/Update-Log.md)
- [数据获取脚本源码](scripts/fetch-plugins-data.js)
- [页面生成脚本源码](scripts/generate-plugin-pages.js)

---

**文档结束**

